<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Supabase Tables</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase Setup & Debug</h1>
        
        <div class="section">
            <h2>1. Test Connection</h2>
            <button onclick="testConnection()">Test Supabase Connection</button>
            <div id="connectionResult"></div>
        </div>
        
        <div class="section">
            <h2>2. Check Tables</h2>
            <button onclick="checkTables()">Check Existing Tables</button>
            <div id="tablesResult"></div>
        </div>
        
        <div class="section">
            <h2>3. Create User Roles Table</h2>
            <p>SQL untuk membuat tabel user_roles:</p>
            <pre>
CREATE TABLE IF NOT EXISTS user_roles (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    role TEXT NOT NULL DEFAULT 'user',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id)
);

-- Enable RLS
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view their own role" ON user_roles
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own role" ON user_roles
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own role" ON user_roles
    FOR UPDATE USING (auth.uid() = user_id);
            </pre>
            <button onclick="createUserRolesTable()">Create User Roles Table</button>
            <div id="createTableResult"></div>
        </div>
        
        <div class="section">
            <h2>4. Test Authentication</h2>
            <p>Test login dengan email yang sudah terdaftar:</p>
            <input type="email" id="testEmail" placeholder="Email" style="width: 200px; padding: 5px; margin: 5px;">
            <input type="password" id="testPassword" placeholder="Password" style="width: 200px; padding: 5px; margin: 5px;">
            <button onclick="testAuth()">Test Login</button>
            <div id="authResult"></div>
        </div>
        
        <div class="section">
            <h2>5. Debug Info</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Supabase configuration
        const supabaseUrl = 'https://yyagythhwzdncantoszf.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5YWd5dGhod3pkbmNhbnRvc3pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NzkzMzcsImV4cCI6MjA3NjE1NTMzN30.R1fbe6pwq6d7ZJ5posqv2m4lhWhdnN9GxeJx-NDv0Yo';
        
        // Create Supabase client
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        window.testConnection = async function() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<p class="info">Testing connection...</p>';
            
            try {
                // Test basic connection
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">Connection failed: ${error.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="success">Connection successful! Session: ${data.session ? 'Active' : 'None'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Connection error: ${error.message}</p>`;
            }
        };
        
        window.checkTables = async function() {
            const resultDiv = document.getElementById('tablesResult');
            resultDiv.innerHTML = '<p class="info">Checking tables...</p>';
            
            try {
                // Check if user_roles table exists
                const { data, error } = await supabase
                    .from('user_roles')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">user_roles table error: ${error.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="success">user_roles table exists! Records: ${data.length}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Table check error: ${error.message}</p>`;
            }
        };
        
        window.createUserRolesTable = async function() {
            const resultDiv = document.getElementById('createTableResult');
            resultDiv.innerHTML = '<p class="info">Creating table... (This requires admin access)</p>';
            
            // Note: This would typically be done in Supabase dashboard
            resultDiv.innerHTML = `
                <p class="info">Please run this SQL in your Supabase dashboard:</p>
                <pre>
CREATE TABLE IF NOT EXISTS user_roles (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    role TEXT NOT NULL DEFAULT 'user',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id)
);

ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own role" ON user_roles
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own role" ON user_roles
    FOR INSERT WITH CHECK (auth.uid() = user_id);
                </pre>
            `;
        };
        
        window.testAuth = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const resultDiv = document.getElementById('authResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<p class="error">Please enter email and password</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">Testing authentication...</p>';
            
            try {
                // Test login
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">Login failed: ${error.message}</p>`;
                } else if (data.user) {
                    // Check user role
                    const { data: roleData, error: roleError } = await supabase
                        .from('user_roles')
                        .select('role')
                        .eq('user_id', data.user.id)
                        .single();
                    
                    const role = roleData?.role || 'user';
                    
                    resultDiv.innerHTML = `
                        <p class="success">Login successful!</p>
                        <p>User ID: ${data.user.id}</p>
                        <p>Email: ${data.user.email}</p>
                        <p>Email Confirmed: ${data.user.email_confirmed_at ? 'Yes' : 'No'}</p>
                        <p>Role: ${role}</p>
                    `;
                } else {
                    resultDiv.innerHTML = '<p class="error">Login failed: No user data</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Auth error: ${error.message}</p>`;
            }
        };
        
        // Load debug info on page load
        window.addEventListener('load', async function() {
            const debugDiv = document.getElementById('debugInfo');
            
            try {
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                const { data: userData, error: userError } = await supabase.auth.getUser();
                
                debugDiv.innerHTML = `
                    <h3>Current State:</h3>
                    <p><strong>Session:</strong> ${sessionData?.session ? 'Active' : 'None'}</p>
                    <p><strong>User:</strong> ${userData?.user ? userData.user.email : 'None'}</p>
                    <p><strong>Supabase URL:</strong> ${supabaseUrl}</p>
                    <p><strong>Error:</strong> ${sessionError?.message || userError?.message || 'None'}</p>
                `;
            } catch (error) {
                debugDiv.innerHTML = `<p class="error">Debug error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>