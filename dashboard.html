<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebGIS Deli Serdang — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/base.css" />
  </head>
  <body>
    <div id="vanta-bg"></div>
    <header class="app-header blur">
      <div class="brand">
        <img src="./assets/icons/logo-deliserdang.jpg" alt="Logo" class="brand-icon" />
        <span class="brand-text">WebGIS Deli Serdang</span>
      </div>
      <nav>
        <button id="logoutBtn" class="btn">Logout</button>
      </nav>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="card" style="padding:16px;">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <strong>Menu</strong>
            <span class="badge">Dashboard</span>
          </div>
          <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
            <button class="btn" onclick="location.href='./map.html'">Open Map</button>
            <button class="btn" onclick="location.href='./irrigation-management.html'">Manajemen Irigasi</button>
            <button class="btn" onclick="alert('Reports coming soon')">Reports</button>
            <button class="btn" id="usersBtn" onclick="toggleUsersPanel()">Users</button>
            <button class="btn" onclick="alert('Settings coming soon')">Settings</button>
          </div>
        </div>
      </aside>
      <main class="content">
        <h2 style="margin-top:0;">Welcome back</h2>
        <div class="card" style="padding:18px;">
          <p>Use the side panel to navigate. Click <strong>Open Map</strong> to view the GIS.</p>
        </div>
        
        <!-- User Management Panel (Admin only) -->
        <div id="usersPanel" class="card" style="padding:18px; margin-top:20px; display:none;">
          <h3>User Management</h3>
          <div id="usersList">
            <p>Loading users...</p>
          </div>
          <div style="margin-top:16px;">
            <button class="btn primary" onclick="refreshUsers()">Refresh Users</button>
          </div>
        </div>
      </main>
    </div>

    <footer class="app-footer">
      <span>© <span id="year"></span> Deli Serdang</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js" onerror="console.error('Failed to load Three.js from CDN')"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@0.5.24/dist/vanta.fog.min.js" onerror="console.warn('Vanta.js failed to load, using fallback background'); document.getElementById('vanta-bg').style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'"></script>
    <script>
      try {
        if (typeof VANTA !== 'undefined' && VANTA.FOG) {
          VANTA.FOG({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            highlightColor: 0xffffff,
            midtoneColor: 0xf2ff,
            lowlightColor: 0xd9d9d9,
            baseColor: 0xffffff,
            blurFactor: 0.57,
            speed: 1.60,
            zoom: 0.80
          });
        } else {
          console.warn('VANTA.FOG not available, using fallback background');
          document.getElementById('vanta-bg').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
      } catch (error) {
        console.error('Error initializing Vanta.js:', error);
        document.getElementById('vanta-bg').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    </script>
    <script type="module" src="./js/utils.js"></script>
    <script type="module" src="./js/auth-guard.js"></script>
    <script type="module">
      import { getCurrentUser, isAdmin } from './js/auth-guard.js';
      import { apiRequest } from './js/utils.js';
      
      try {
        document.getElementById('year').textContent = new Date().getFullYear();
      } catch (error) {
        console.error('Error setting year:', error);
      }
      
      // Check if user is admin and show/hide admin features
      try {
        const user = getCurrentUser();
        if (!isAdmin()) {
          document.getElementById('usersBtn').style.display = 'none';
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
      }
      
      // User management functions
      window.toggleUsersPanel = function() {
        try {
          const panel = document.getElementById('usersPanel');
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          if (panel.style.display === 'block') {
            refreshUsers();
          }
        } catch (error) {
          console.error('Error toggling users panel:', error);
        }
      };
      
      window.refreshUsers = async function() {
        try {
          const usersList = document.getElementById('usersList');
          usersList.innerHTML = '<p>Loading users...</p>';
          
          try {
            const API_BASE_URL = import.meta.env?.VITE_SUPABASE_URL || '';
            const API_KEY = import.meta.env?.VITE_SUPABASE_ANON_KEY || '';
            
            const response = await fetch(`${API_BASE_URL}/functions/v1/auth`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
              },
              body: JSON.stringify({
                action: 'get_users'
              })
            });

            const result = await response.json();

            if (response.ok && result.success) {
              let html = '<table class="data-table"><thead><tr>';
              html += '<th>Email</th><th>Nama</th><th>Role</th><th>Status</th><th>Last Login</th><th>Aksi</th>';
              html += '</tr></thead><tbody>';

              result.users.forEach(user => {
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                const status = user.is_active ? 'Active' : 'Inactive';
                html += '<tr>';
                html += `<td>${user.email}</td>`;
                html += `<td>${user.full_name}</td>`;
                html += `<td><span class="badge">${user.role}</span></td>`;
                html += `<td>${status}</td>`;
                html += `<td>${lastLogin}</td>`;
                html += `<td>
                  <button class="action-btn edit" onclick="editUser('${user.id}')">Edit</button>
                  <button class="action-btn delete" onclick="deleteUser('${user.id}')">Delete</button>
                </td>`;
                html += '</tr>';
              });

              html += '</tbody></table>';
              usersList.innerHTML = html;
            } else {
              usersList.innerHTML = `<p style="color: red;">Error: ${result.error || 'Failed to load users'}</p>`;
            }
          } catch (error) {
            console.error('Error loading users:', error);
            usersList.innerHTML = '<p style="color: red;">Error loading users</p>';
          }
        } catch (error) {
          console.error('Error in refreshUsers:', error);
        }
      };

      // Edit user function
      window.editUser = function(userId) {
        alert(`Edit user: ${userId}\nFitur edit user akan diimplementasikan.`);
      };

      // Delete user function
      window.deleteUser = async function(userId) {
        if (!confirm('Apakah Anda yakin ingin menghapus user ini?')) {
          return;
        }

        try {
          const API_BASE_URL = import.meta.env?.VITE_SUPABASE_URL || '';
          const API_KEY = import.meta.env?.VITE_SUPABASE_ANON_KEY || '';
          
          const response = await fetch(`${API_BASE_URL}/functions/v1/auth`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
              action: 'delete_user',
              user_id: userId
            })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert('User berhasil dihapus');
            refreshUsers();
          } else {
            alert(`Error: ${result.error || 'Failed to delete user'}`);
          }
        } catch (error) {
          console.error('Error deleting user:', error);
          alert('Error deleting user');
        }
      };
    </script>
    
  </body>
</html>
